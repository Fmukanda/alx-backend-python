#!/bin/bash
# kubctl-0x02.sh
# Perform blue-green zero-downtime deployment for Django app

set -e  # Exit if any command fails

echo "ğŸš€ Starting Blue-Green Deployment process..."

# Step 1: Deploy Blue version (existing version)
echo "ğŸ”¹ Applying Blue Deployment..."
kubectl apply -f blue_deployment.yaml

# Step 2: Deploy Green version (new version)
echo "ğŸŸ¢ Applying Green Deployment..."
kubectl apply -f green_deployment.yaml

# Wait for pods to start
echo "â³ Waiting for pods to initialize..."
sleep 20

# Step 3: Check that both versions are running
echo "ğŸ” Verifying running pods..."
kubectl get pods -l app=messaging-app -o wide

# Step 4: Check logs of the new version (green)
echo "ğŸ“œ Checking logs for Green pods..."
GREEN_POD=$(kubectl get pods -l version=green -o jsonpath="{.items[0].metadata.name}")
kubectl logs $GREEN_POD | tail -n 20

# Step 5: Switch service traffic to Green
echo "ğŸ” Switching traffic to Green version..."
kubectl patch service messaging-app-service -p '{"spec": {"selector": {"app": "messaging-app", "version": "green"}}}'

# Step 6: Verify new traffic routing
echo "âœ… Updated service routing:"
kubectl get service messaging-app-service -o yaml | grep version

# Step 7: Optional â€” Monitor both versions briefly
echo "ğŸ“Š Current pod status:"
kubectl get pods -l app=messaging-app

echo "ğŸ‰ Blue-Green Deployment completed successfully!"
